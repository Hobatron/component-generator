<div class="designer-container">
  <!-- Left Toolbar -->
  <aside class="designer-toolbar">
    <div class="toolbar-header">
      <h3 class="toolbar-title">Components</h3>
      <p class="toolbar-subtitle">Available fields</p>
    </div>

    <div class="toolbar-section">
      <h4 class="section-title">Card Size</h4>
      <div class="card-size-selector">
        <select class="size-dropdown" (change)="changeCardSize($event)">
          @for (preset of cardPresets; track preset.key) {
          <option [value]="preset.key" [selected]="canvasSize().name === preset.name">
            {{ preset.name }}
          </option>
          }
        </select>
        <div class="size-info">
          <div class="size-detail">
            <strong
              >{{ canvasSize().physicalSize.inches.width }}" √ó
              {{ canvasSize().physicalSize.inches.height }}"</strong
            >
          </div>
          <div class="size-detail-small">
            {{ canvasSize().physicalSize.mm.width }}mm √ó {{ canvasSize().physicalSize.mm.height }}mm
          </div>
          <div class="size-detail-small">
            {{ canvasSize().width }}px √ó {{ canvasSize().height }}px
          </div>
        </div>
      </div>
    </div>

    <div class="toolbar-section">
      <h4 class="section-title">Fields</h4>
      <div class="field-list">
        @for (field of availableFields(); track field.id) {
        <div
          class="field-item"
          [class.disabled]="field.isUsed"
          (click)="!field.isUsed && addComponent(field.id, field.type)"
        >
          <span class="field-label">{{ field.label }}</span>
        </div>
        } @empty {
        <p class="empty-message">No fields in schema</p>
        }
      </div>
    </div>
  </aside>

  <!-- Right Canvas Area -->
  <main class="designer-canvas-area">
    <div class="canvas-header">
      <h2 class="canvas-title">Card Layout Designer</h2>
      <div class="canvas-actions">
        <label class="grid-toggle">
          <input type="checkbox" [checked]="showGrid()" (change)="toggleGrid()" />
          <span>Show Grid</span>
        </label>
        <button class="btn btn-secondary" (click)="closeDesigner()">Cancel</button>
        <button class="btn btn-primary" (click)="saveLayout()">Save</button>
      </div>
    </div>

    <div class="canvas-wrapper">
      <div
        class="canvas"
        [class.show-grid]="showGrid()"
        [style.width.px]="canvasSize().width"
        [style.height.px]="canvasSize().height"
        [style.background-size.px]="gridSize()"
        (click)="closePropertiesPanel()"
      >
        <!-- Components will be rendered here -->
        @for (component of components(); track component.id) {
        <div
          class="canvas-component"
          cdkDrag
          [cdkDragFreeDragPosition]="component.position"
          [style.width.px]="component.size.width"
          [style.height.px]="component.size.height"
          [style.font-family]="component.style?.fontFamily || 'Arial'"
          [style.font-size.px]="component.style?.fontSize || 16"
          [style.font-weight]="component.style?.fontWeight || 'normal'"
          [style.text-align]="component.style?.textAlign || 'left'"
          [style.color]="component.style?.color || '#000000'"
          [style.background-color]="component.style?.backgroundColor"
          cdkDragBoundary=".canvas"
          (cdkDragEnded)="onDragEnded($event, component)"
          (click)="selectComponentVisually($event, component.id)"
          (contextmenu)="openProperties($event, component.id)"
          [class.selected]="selectedComponentId() === component.id"
        >
          <span class="component-label">{{ component.fieldId }}</span>

          <!-- Resize handles -->
          @if (selectedComponentId() === component.id) {
          <div
            class="resize-handle resize-se"
            (mousedown)="startResize($event, component.id, 'se')"
          ></div>
          <div
            class="resize-handle resize-ne"
            (mousedown)="startResize($event, component.id, 'ne')"
          ></div>
          <div
            class="resize-handle resize-sw"
            (mousedown)="startResize($event, component.id, 'sw')"
          ></div>
          <div
            class="resize-handle resize-nw"
            (mousedown)="startResize($event, component.id, 'nw')"
          ></div>
          }
        </div>
        } @empty {
        <div class="canvas-empty">
          <p>Add fields from the toolbar</p>
          <p class="canvas-hint">Right-click components to edit properties</p>
        </div>
        }
      </div>
    </div>
  </main>

  <!-- Properties Panel (Right Sidebar) -->
  @if (showPropertiesPanel() && selectedComponent(); as component) {
  <aside class="properties-panel">
    <div class="properties-header">
      <h3 class="properties-title">Component Properties</h3>
      <button class="close-properties" (click)="showPropertiesPanel.set(false)" type="button">
        ‚úï
      </button>
    </div>

    <div class="properties-body">
      <!-- Field Info -->
      <div class="property-section">
        <div class="property-info">
          <span class="property-label">Field:</span>
          <span class="property-value">{{ component.fieldId }}</span>
        </div>
        <div class="property-info">
          <span class="property-label">Type:</span>
          <span class="property-value">{{ component.type }}</span>
        </div>
      </div>

      <!-- Typography Section -->
      <div class="property-section">
        <h4 class="section-title">Typography</h4>

        <div class="property-group">
          <label class="property-label">Font Family</label>
          <select
            class="property-select"
            [value]="component.style?.fontFamily || 'Arial'"
            (change)="updateFontFamily($any($event.target).value)"
          >
            @for (font of availableFonts; track font) {
            <option [value]="font">{{ font }}</option>
            }
          </select>
        </div>

        <div class="property-group">
          <label class="property-label">Font Size</label>
          <select
            class="property-select"
            [value]="component.style?.fontSize || 16"
            (change)="updateFontSize(+$any($event.target).value)"
          >
            @for (size of fontSizes; track size) {
            <option [value]="size">{{ size }}px</option>
            }
          </select>
        </div>

        <div class="property-group">
          <label class="property-label">Font Weight</label>
          <select
            class="property-select"
            [value]="component.style?.fontWeight || 'normal'"
            (change)="updateFontWeight($any($event.target).value)"
          >
            @for (weight of fontWeights; track weight.value) {
            <option [value]="weight.value">{{ weight.label }}</option>
            }
          </select>
        </div>

        <div class="property-group">
          <label class="property-label">Text Align</label>
          <div class="align-buttons">
            <button
              type="button"
              class="align-btn"
              [class.active]="component.style?.textAlign === 'left' || !component.style?.textAlign"
              (click)="updateTextAlign('left')"
              title="Align Left"
            >
              ‚óß
            </button>
            <button
              type="button"
              class="align-btn"
              [class.active]="component.style?.textAlign === 'center'"
              (click)="updateTextAlign('center')"
              title="Align Center"
            >
              ‚ñ≠
            </button>
            <button
              type="button"
              class="align-btn"
              [class.active]="component.style?.textAlign === 'right'"
              (click)="updateTextAlign('right')"
              title="Align Right"
            >
              ‚ó®
            </button>
          </div>
        </div>
      </div>

      <!-- Appearance Section -->
      <div class="property-section">
        <h4 class="section-title">Appearance</h4>

        <div class="property-group">
          <label class="property-label">Text Color</label>
          <input
            type="color"
            class="property-color"
            [value]="component.style?.color || '#000000'"
            (change)="updateColor($any($event.target).value)"
          />
          <span class="color-value">{{ component.style?.color || '#000000' }}</span>
        </div>

        <div class="property-group">
          <label class="property-label">Background</label>
          <div class="color-control">
            <input
              type="color"
              class="property-color"
              [value]="component.style?.backgroundColor || '#ffffff'"
              [disabled]="!component.style?.backgroundColor"
              (change)="updateBackgroundColor($any($event.target).value)"
            />
            <span class="color-value">{{ component.style?.backgroundColor || 'None' }}</span>
            <label class="transparent-toggle">
              <input
                type="checkbox"
                [checked]="!component.style?.backgroundColor"
                (change)="toggleTransparentBackground($any($event.target).checked)"
              />
              <span>Transparent</span>
            </label>
          </div>
        </div>
      </div>

      <!-- Position Section -->
      <div class="property-section">
        <h4 class="section-title">Position</h4>

        <div class="property-row">
          <div class="property-group-half">
            <label class="property-label">X</label>
            <input type="number" class="property-input" [value]="component.position.x" readonly />
          </div>
          <div class="property-group-half">
            <label class="property-label">Y</label>
            <input type="number" class="property-input" [value]="component.position.y" readonly />
          </div>
        </div>

        <div class="property-row">
          <div class="property-group-half">
            <label class="property-label">Width</label>
            <input type="number" class="property-input" [value]="component.size.width" readonly />
          </div>
          <div class="property-group-half">
            <label class="property-label">Height</label>
            <input type="number" class="property-input" [value]="component.size.height" readonly />
          </div>
        </div>
      </div>

      <!-- Delete Button -->
      <div class="property-section">
        <button type="button" class="btn-delete" (click)="deleteSelectedComponent()">
          üóëÔ∏è Delete Component
        </button>
      </div>
    </div>
  </aside>
  }
</div>

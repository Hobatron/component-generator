<div class="project-page">
  <header class="project-header">
    <div class="header-content">
      <h1>{{ formatProjectName(projectName$ | async) }}</h1>
      <button class="add-category-btn" (click)="openAddCategoryModal()">
        <span class="btn-icon">‚ûï</span>
        Add New Category
      </button>
    </div>
  </header>

  <div class="collections-grid">
    @for (section of sections$ | async; track section) {
    <section class="collection-card">
      <div class="card-header">
        <div class="section-icon">
          @if (getSchemaForSection(section); as schema) {
          {{ schema.icon }}
          } @else { @switch (section) { @case ('actions') { ‚öîÔ∏è } @case ('equipments') { üõ°Ô∏è } @case
          ('usables') { üß™ } @case ('characters') { üë§ } @case ('spells') { ‚ú® } @default { üìÅ } } }
        </div>
        <h2 class="section-title">
          @if (getSchemaForSection(section); as schema) {
          {{ schema.name }}
          } @else {
          {{ section | titlecase }}
          }
        </h2>
      </div>

      <div class="card-content">
        <p class="section-description">Manage {{ section }} for this project</p>
        <div class="card-actions">
          <a
            [routerLink]="'/projects/' + (projectName$ | async) + '/' + section"
            class="nav-button primary"
          >
            View {{ section | titlecase }}
          </a>
          @if (getSchemaForSection(section); as schema) {
          <button class="nav-button secondary" (click)="openEditCategoryModal(schema)">
            ‚úèÔ∏è Edit
          </button>
          }
        </div>
      </div>
    </section>
    }
  </div>

  <!-- Add Category Modal -->
  @if (isAddingCategory()) {
  <div class="modal-overlay" (click)="closeAddCategoryModal()">
    <div class="modal-container" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2 class="modal-title">Add New Category</h2>
        <button class="close-button" (click)="closeAddCategoryModal()" type="button">‚úï</button>
      </div>

      <div class="modal-body">
        <div class="form-group">
          <label class="form-label" for="categoryName">Category Name</label>
          <input
            type="text"
            id="categoryName"
            [value]="newCategoryName()"
            (input)="newCategoryName.set($any($event.target).value)"
            class="form-input"
            placeholder="e.g., Spells, Monsters, Locations"
          />
        </div>

        <div class="form-group">
          <label class="form-label" for="categoryIcon">Icon</label>
          <select
            id="categoryIcon"
            [value]="newCategoryIcon()"
            (change)="newCategoryIcon.set($any($event.target).value)"
            class="form-select"
          >
            @for (option of emojiOptions; track option.emoji) {
            <option [value]="option.emoji">{{ option.emoji }} {{ option.label }}</option>
            }
          </select>
          <small class="form-hint">Choose an emoji to represent this category</small>
        </div>

        <div class="info-box">
          <strong>Note:</strong> The category will be created with a basic ID field. You can add
          more fields later by editing the category schema.
        </div>
      </div>

      <div class="modal-footer">
        <button type="button" class="button button-secondary" (click)="closeAddCategoryModal()">
          Cancel
        </button>
        <button
          type="button"
          class="button button-primary"
          (click)="createCategory()"
          [disabled]="!newCategoryName().trim()"
        >
          Create Category
        </button>
      </div>
    </div>
  </div>
  }

  <!-- Edit Category Modal -->
  @if (isEditingCategory() && editingSchema(); as schema) {
  <div class="modal-overlay" (click)="closeEditCategoryModal()">
    <div class="modal-container modal-wide" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2 class="modal-title">Edit Category</h2>
        <button class="close-button" (click)="closeEditCategoryModal()" type="button">‚úï</button>
      </div>

      <!-- Material Tabs -->
      <mat-tab-group [(selectedIndex)]="activeTabIndex" (selectedIndexChange)="onTabChange($event)">
        <mat-tab label="üìù Fields">
          <div class="modal-body">
            <div class="form-group">
              <label class="form-label" for="editCategoryName">Category Name</label>
              <input
                type="text"
                id="editCategoryName"
                [value]="editCategoryName()"
                (input)="editCategoryName.set($any($event.target).value)"
                class="form-input"
                placeholder="e.g., Spells, Monsters, Locations"
              />
            </div>

            <div class="form-group">
              <label class="form-label" for="editCategoryIcon">Icon</label>
              <select
                id="editCategoryIcon"
                [value]="editCategoryIcon()"
                (change)="editCategoryIcon.set($any($event.target).value)"
                class="form-select"
              >
                @for (option of emojiOptions; track option.emoji) {
                <option [value]="option.emoji" [selected]="option.emoji === editCategoryIcon()">
                  {{ option.emoji }} {{ option.label }}
                </option>
                }
              </select>
              <small class="form-hint">Choose an emoji to represent this category</small>
            </div>

            <div class="form-group">
              <label class="form-label">Fields</label>
              <div class="fields-list">
                @for (field of editingFields(); track field.name) {
                <div class="field-item">
                  <div class="field-info">
                    <span class="field-name">{{ field.label }}</span>
                    <span class="field-type">{{ field.type }}</span>
                    @if (field.required) {
                    <span class="field-badge required">Required</span>
                    } @if (field.options) {
                    <span class="field-badge">{{ field.options.length }} options</span>
                    }
                  </div>
                  @if (field.name !== 'id') {
                  <button
                    type="button"
                    class="button-icon button-danger-icon"
                    (click)="removeField(field.name)"
                    title="Remove field"
                  >
                    üóëÔ∏è
                  </button>
                  }
                </div>
                }
              </div>

              @if (!isAddingField()) {
              <button type="button" class="button button-secondary" (click)="openAddFieldForm()">
                ‚ûï Add Field
              </button>
              } @else {
              <div class="add-field-form">
                <div class="form-row">
                  <div class="form-col">
                    <label class="form-label-small">Field Name</label>
                    <input
                      type="text"
                      [value]="newFieldName()"
                      (input)="newFieldName.set($any($event.target).value)"
                      class="form-input-small"
                      placeholder="e.g., damage"
                    />
                  </div>
                  <div class="form-col">
                    <label class="form-label-small">Label</label>
                    <input
                      type="text"
                      [value]="newFieldLabel()"
                      (input)="newFieldLabel.set($any($event.target).value)"
                      class="form-input-small"
                      placeholder="e.g., Damage"
                    />
                  </div>
                </div>

                <div class="form-row">
                  <div class="form-col">
                    <label class="form-label-small">Type</label>
                    <select
                      [value]="newFieldType()"
                      (change)="newFieldType.set($any($event.target).value)"
                      class="form-select-small"
                    >
                      <option value="text">Text</option>
                      <option value="number">Number</option>
                      <option value="textarea">Textarea</option>
                      <option value="dropdown">Dropdown</option>
                    </select>
                  </div>
                  <div class="form-col">
                    <label class="form-label-small">
                      <input
                        type="checkbox"
                        [checked]="newFieldRequired()"
                        (change)="newFieldRequired.set($any($event.target).checked)"
                      />
                      Required
                    </label>
                  </div>
                </div>

                @if (newFieldType() === 'dropdown') {
                <div class="form-row">
                  <div class="form-col-full">
                    <label class="form-label-small">Options (comma-separated)</label>
                    <input
                      type="text"
                      [value]="newFieldOptions()"
                      (input)="newFieldOptions.set($any($event.target).value)"
                      class="form-input-small"
                      placeholder="e.g., Fire, Ice, Lightning"
                    />
                  </div>
                </div>
                }

                <div class="form-actions">
                  <button
                    type="button"
                    class="button button-secondary-small"
                    (click)="cancelAddField()"
                  >
                    Cancel
                  </button>
                  <button type="button" class="button button-primary-small" (click)="addField()">
                    Add Field
                  </button>
                </div>
              </div>
              }
            </div>

            <div class="danger-zone">
              <h3 class="danger-title">Danger Zone</h3>
              <p class="danger-description">
                Deleting this category will remove the schema but keep existing items.
              </p>
              <button type="button" class="button button-danger" (click)="deleteCategory(schema)">
                üóëÔ∏è Delete Category
              </button>
            </div>
          </div>
        </mat-tab>

        <mat-tab label="üé® Card Layout">
          <div class="layout-designer-wrapper">
            <app-card-layout-designer
              [schemaFields]="editingFields()"
              [existingLayout]="schema.cardLayout"
              (layoutSaved)="onLayoutSaved($event)"
              (designerClosed)="closeEditCategoryModal()"
            />
          </div>
        </mat-tab>
      </mat-tab-group>

      <div class="modal-footer">
        <button type="button" class="button button-secondary" (click)="handleCancel()">
          Cancel
        </button>
        <button
          type="button"
          class="button button-primary"
          (click)="updateCategory()"
          [disabled]="!editCategoryName().trim()"
        >
          Save Changes
        </button>
      </div>
    </div>
  </div>
  }
</div>
